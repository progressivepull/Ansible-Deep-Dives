# 3.1 Introduction

# What is an Ansible playbook?

An Ansible playbook is a YAML file (.yml) that describes:

* Which hosts to manage
* What tasks to run
* In what order
* Under what conditions

Playbooks are declarative: you describe the desired state, not the exact steps.

## Basic playbook structure

``` yaml
- name: Play description
  hosts: target_hosts
  gather_facts: yes
  tasks:
    - name: Task description
      module_name:
        option: value

```

---
**- name: Play description**

* This starts a play
* The dash (-) means this is an item in a list (a playbook can have multiple plays)
* **name** is a human-readable description
* It appears in Ansible output so you can understand what the play is doing

Example output:
```
PLAY [Play description] *************************************************
```

---

**hosts: target_hosts**

* Defines which machines this play runs on
* target_hosts can be:
    - A group from inventory (webservers)
    - A single host (web01)
    - Multiple groups (webservers,dbservers)
    - all

Example:
```
hosts: webservers
```
Ansible will connect only to these hosts.

---

**gather_facts: yes**

* Tells Ansible to collect system information before running tasks
* Uses the setup module internally
* Populates variables like:

    - ansible_distribution
    - ansible_os_family
    - ansible_hostname
    - ansible_memtotal_mb

Default value is yes.

You can disable it for speed:

``` yaml
gather_facts: no
```

--- 


**module_name:**

* This is the Ansible module being used
* Modules are the “units of work” in Ansible

Common modules:

* ping
* copy
* file
* service
* yum, apt
* template
* debug

Example:
``` yaml
ping:
```
---

**option: value**

* These are module parameters
* Each module has its own options

Example:

``` yaml
copy:
  src: app.conf
  dest: /etc/app.conf
  owner: root
  mode: '0644'
```

# How this runs (execution flow)

1. Ansible reads the playbook
2. Matches hosts from inventory
3. Gathers facts (if enabled)
4. Runs tasks in order
5. Applies each task to each host

# Fully filled example

``` yaml
- name: Install Apache web server
  hosts: webservers
  gather_facts: yes

  tasks:
    - name: Install Apache
      yum:
        name: httpd
        state: present

```

# What are Ansible facts?

**Facts** are variables that describe the **current state of a host**, such as:

* Operating system and version
* Hostname and domain
* IP addresses and network interfaces
* CPU, memory, and disk info
* Virtualization and cloud metadata

## Common facts you’ll use
|Fact                                   | 	What it tells you                 | 
|---------------------------------------|-------------------------------------|
| ansible_distribution                  |	OS name (Ubuntu, RedHat, Rocky)   |
| ansible_os_family                     |	OS family (Debian, RedHat)        |
| ansible_distribution_major_version    |	OS major version                  |
| ansible_hostname	                    |   Short hostname                    |
| ansible_default_ipv4.address          | 	Primary IP                        |
| ansible_memtotal_mb	                |   Total RAM                         |
| ansible_processor_vcpus               |   CPU count                         |


## Using facts in tasks
Example: Print a fact

``` yaml
- name: Show OS
  debug:
    msg: "OS is {{ ansible_distribution }}"
```

## Example: Conditional execution

``` yaml
- name: Install Apache on Debian systems
  apt:
    name: apache2
    state: present
  when: ansible_os_family == "Debian"
```
## Example: OS-specific logic

``` yaml

- name: Install web server
  hosts: webservers
  gather_facts: yes

  tasks:
    - name: Debian-based install
      apt:
        name: apache2
        state: present
      when: ansible_distribution in ["Ubuntu", "Debian"]

    - name: RHEL-based install
      yum:
        name: httpd
        state: present
      when: ansible_distribution in ["RedHat", "Rocky", "Amazon"]
```

## Viewing facts
All facts (very verbose)
``` bash
ansible webservers -m setup
```
## Filtered facts (recommended)

``` bash
ansible webservers -m setup -a 'filter=ansible_distribution'
```

## In a playbook (debug)
``` yaml
- name: Show all facts
  debug:
    var: ansible_facts
```

## Disabling facts
Facts can be expensive on large inventories.

``` yaml
gather_facts: no
```

* Use this when:
    - You don’t need system info
    - You want faster runs

## Minimal facts (faster)
``` yaml
- hosts: webservers
  gather_facts: yes
  gather_subset:
    - min
```

## Fact caching (advanced)

Facts can be cached to avoid re-collection:
``` yaml
[defaults]
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 3600
```

# Important distinctions             

| Item	        | Facts	                    | Variables             |
|---------------|---------------------------|-----------------------|
|   Source	    |Discovered automatically   |	Defined by you      |
|   Timing	    |Collected at play start    |	Any time            |
|   Scope	    |Host-specific	            |   Flexible            |



## Common mistakes

* ❌ Assuming facts exist when gather_facts: no
* ❌ Using facts before they are gathered
* ❌ Confusing ${{ }} (CI) with {{ }} (Ansible)


# Idempotent

Idempotent means:         

* You can run the same operation multiple times and the result will be the same after the first successful run.
* In Ansible, idempotency is a core design principle.

## What idempotent means in practice

If a task is idempotent:

* First run → makes a change if needed
* Subsequent runs → do nothing because the system is already in the desired state
* No unintended side effects

## Simple example (idempotent)

``` yaml
- name: Ensure Apache is installed
  yum:
    name: httpd
    state: present
```
What happens:

* Apache not installed → Ansible installs it (changed)
* Apache already installed → Ansible does nothing (ok)

You can safely run this playbook over and over.

## Making non-idempotent tasks idempotent
Use a proper module

❌ Bad:
``` yaml
shell: useradd appuser
``` 

✅ Good:
``` yaml
user:
  name: appuser
  state: present
```

## Use creates or removes
``` yaml
- name: Run script once
  command: /usr/local/bin/setup.sh
  args:
    creates: /etc/app/config.yaml
```
Runs only if the file does not exist.

# How Ansible reports idempotency
| Status        |	Meaning             |
|---------------|-----------------------|
|changed	    | System was modified   |
|ok	            | Already correct       |
|failed         |	Error occurred      |
|skipped        |	Condition not met   |


# Idempotency and facts

Ansible uses facts to determine whether a change is needed:

``` yaml
when: ansible_os_family == "Debian"
```






# Key concepts to remember

| Item               |	Meaning                          |
|--------------------|-----------------------------------|
| Play	             |  A set of tasks applied to hosts  |
| Task               |	One action using one module      |
| Module             |	Tool that does the work          |
| Facts              |	System info used for logic       |
| Idempotent         |	Safe to run repeatedly           |